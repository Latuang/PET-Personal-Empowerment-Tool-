<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PET Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg-a:#fff4ea; --bg-b:#fde9f2; --bg-c:#e9fbf1;
      --ink:#2b2723; --ink-soft:#7b716a;
      --line:#d9cdc5; --line-strong:#cdbfb6;
      --accent:#2f8d7c; --accent-soft:#e8f3f0;
      --peach:#ffa191; --mint:#6cc7b3; --honey:#ffd674;
      --radius:14px; --shadow:0 10px 26px rgba(40,26,16,.10), 0 2px 10px rgba(40,26,16,.06);
    }
    html,body{height:100%}
    body{ margin:0; color:var(--ink);
      font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, var(--bg-a), var(--bg-b) 45%, var(--bg-c) 100%); -webkit-font-smoothing:antialiased; overflow-x:hidden;}
    .wrap{ max-width: 1000px; margin: clamp(16px,4vh,28px) auto; padding:14px; background:#fffdfb;
      border:1.5px solid var(--line); border-radius:18px; box-shadow:var(--shadow); display:grid; gap:12px;}
    .top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .title{ display:flex; align-items:center; gap:8px; }
    .title h1{ margin:0; font-weight:700; font-size: clamp(18px,2.1vw,22px); letter-spacing:.2px; }
    .subtitle{ margin:2px 0 0; color:var(--ink-soft); font-size:12.5px }
    .toolbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .chip{ display:flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; background:#fff; border:1.5px solid var(--line);
      box-shadow: 0 2px 8px rgba(0,0,0,.05); font-weight:600; }
    .chip input{ width:58px; border:1.5px solid var(--line-strong); border-radius:8px; padding:6px 6px; text-align:center; font:600 13px/1 system-ui; outline:none; background:#fff; }
    .btn{ appearance:none; border:1.5px solid var(--line-strong); background: linear-gradient(#ffffff, #faf7f4);
      padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; color:#245e54; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    .grid{ display:grid; gap:12px; grid-template-columns: 1.05fr .95fr; min-height:0; }
    @media (max-width: 920px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:#fffaf6; border:1.5px solid var(--line); border-radius: var(--radius); padding:12px; min-height:0; display:grid; gap:8px; }
    .card h2{ margin:0; font-size:15px; display:flex; align-items:center; gap:6px; }
    .field{ border:1.5px solid var(--line-strong); background:#fff; border-radius:12px; overflow:hidden; box-shadow: inset 0 1px 0 rgba(0,0,0,.04); }
    textarea{ width:100%; min-height:138px; max-height:190px; resize:vertical; border:0; outline:0; padding:10px 12px 12px; background:#fff; color:var(--ink);
      font: 13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn.peach{ color:#6b2b24; background:linear-gradient(#fff,#fff) padding-box, linear-gradient(90deg,#ffb6a9,#ffc6c6) border-box; border:1.5px solid transparent; }
    .btn.mint{ color:#20584d; background:linear-gradient(#fff,#fff) padding-box, linear-gradient(90deg,#b8ece2,#c7f2eb) border-box; border:1.5px solid transparent; }
    .status{ margin-left:auto; color:#b22626; font-size:12px }
    .timer{ display:grid; gap:10px; grid-template-rows:auto auto auto; background:#fffaf6; border:1.5px solid var(--line); border-radius: var(--radius); padding:12px; }
    .lcd{ margin:2px auto 4px; border:1.5px solid var(--line-strong); background: linear-gradient(180deg,#fff7c5,#ffe38c);
      color:#1e1a14; font: 800 26px/1 "JetBrains Mono", ui-monospace, Menlo, Consolas, monospace; letter-spacing:1.5px; padding:10px 12px 8px; border-radius:10px;
      min-width:140px; text-align:center; box-shadow: inset 0 1px 0 #fffbe0, inset 0 -2px 0 #e7c86a; }
    .actions{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .pill{ padding:8px 10px; border-radius:10px; border:1.5px solid var(--line-strong); background:#fff; cursor:pointer; font-weight:700; box-shadow:0 1px 6px rgba(0,0,0,.06); }
    .pill.start{ background:#e7faf4; color:#24695d } .pill.pause{ background:#fff0ed; color:#7a3c34 } .pill.reset{ background:#fff8df; color:#6d5a23 }
    .inputs{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    .ibox{ background:#fff; border:1.5px solid var(--line-strong); border-radius:10px; padding:6px; text-align:center; }
    .ibox label{ display:block; font-size:11px; color:var(--ink-soft); }
    .ibox input{ width:100%; border:0; outline:0; background:transparent; font:700 16px/1 system-ui; color:#333; text-align:center; }

    /* Pawprint */
    .paw{ background:#fffaf6; border:1.5px solid var(--line); border-radius: var(--radius); padding:12px; display:grid; gap:10px; }
    .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
    .kpi{ background:#fff; border:1.5px solid var(--line-strong); border-radius:10px; padding:8px; text-align:center; }
    .kpi strong{ font-size:14px } .kpi small{ display:block; font-size:11px; color:var(--ink-soft) }
    .chartShell{ border:1.5px solid var(--line-strong); border-radius:10px; background:#fff; padding:8px; }
    .chartViewport{ overflow:hidden; position:relative; height:88px }
    .chart{ display:flex; align-items:flex-end; gap:10px; height:88px; padding:0 8px }
    .bar{ width:18px; background:var(--accent-soft); border:1.5px solid #cfe5df; border-radius:6px; position:relative; overflow:hidden }
    .bar>span{ position:absolute; bottom:0; left:0; right:0; height:0%; background:var(--accent); border-radius:6px }
    .barLabel{ position:absolute; bottom:-18px; left:50%; transform:translateX(-50%); font-size:10px; color:#8a8078; white-space:nowrap }

    /* Choose Your PET ‚Äî 3x2 grid, always filled */
    .pets{ background:#fffaf6; border:1.5px solid var(--line); border-radius:var(--radius); padding:12px; display:grid; gap:8px }
    .pets h2{ margin:0; font-size:15px }
    .petGrid{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px }
    .petOpt{ position:relative; border:1.5px solid var(--line-strong); background:#fff; border-radius:10px; padding:0; display:grid; place-items:center; cursor:pointer; transition:transform .05s; aspect-ratio:1/1; overflow:hidden }
    .petOpt img{ width:100%; height:100%; object-fit:contain; display:block; mix-blend-mode:multiply }
    .petOpt:hover{ transform:translateY(-1px) }
    .petOpt.active{ outline:2px solid var(--accent); box-shadow:inset 0 0 0 2px #fff }

    .left{ display:grid; gap:12px; grid-template-rows:auto 1fr }
    .right{ display:grid; gap:12px; grid-template-rows:auto auto 1fr }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="top">
      <div class="title">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 7h12M6 12h9M6 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <div>
          <h1>PET Control Panel</h1>
          <div class="subtitle">Personal Empowerment Tool</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="chip">Talk every
          <input id="freq" type="number" min="1" value="45" aria-label="Talk frequency (minutes)"/> min
        </div>
        <button id="freqSave" class="btn">Save</button>
      </div>
    </div>

    <div class="grid">
      <div class="left">
        <section class="card">
          <h2>üí¨ Pep Lines</h2>
          <div class="field"><textarea id="lines" placeholder="One line per row&#10;e.g. Tiny step now‚Äîfuture you says thanks."></textarea></div>
          <div class="row">
            <button id="save" class="btn peach">Save to PET ‚ú®</button>
            <button id="load" class="btn mint">Load from PET üçÉ</button>
            <div id="status" class="status" role="status" aria-live="polite"></div>
          </div>
        </section>

        <section class="paw">
          <h2>üêæ Progress Pawprint</h2>
          <div class="kpis">
            <div class="kpi"><strong id="kToday">0m</strong><small>Today</small></div>
            <div class="kpi"><strong id="k7">0m</strong><small>Last 7 days</small></div>
            <div class="kpi"><strong id="kStreak">0</strong><small>Current Streak</small></div>
            <div class="kpi"><strong id="kLongest">0</strong><small>Longest</small></div>
          </div>
          <div class="chartShell">
            <div class="chartViewport"><div id="chart" class="chart" aria-hidden="true"></div></div>
          </div>
        </section>
      </div>

      <div class="right">
        <section class="card timer" aria-label="Focus Timer">
          <h2>üï∞Ô∏è Focus Timer</h2>
          <div class="lcd" id="lcd">25:00</div>
          <div class="actions">
            <button class="pill start" id="start">Start</button>
            <button class="pill pause" id="pause">Pause</button>
            <button class="pill reset" id="reset">Reset</button>
            <button class="pill" id="p5">5m</button>
            <button class="pill" id="p25">25m</button>
          </div>
          <div class="inputs">
            <div class="ibox"><label>Hours</label><input id="h" type="number" min="0" value="0"></div>
            <div class="ibox"><label>Minutes</label><input id="m" type="number" min="0" value="25"></div>
            <div class="ibox"><label>Seconds</label><input id="s" type="number" min="0" value="0"></div>
          </div>
        </section>

        <section class="pets">
          <h2>üß∏ Choose Your PET</h2>
          <div id="petGrid" class="petGrid" role="listbox" aria-label="Choose your PET"></div>
        </section>
      </div>
    </div>
  </main>

  <script>
    // ---------- Control page <-> Extension ----------
    const EXT_ID = "libkjkfhpilbfmcbknhnhnfejacjkccd"; // <‚Äî set your ID!
    const statusEl = document.getElementById('status');
    const say = (txt, ok=true)=>{ statusEl.textContent = txt; statusEl.style.color = ok ? '#0f7d4c' : '#b00020'; };
    const canUseAPI = () => typeof chrome !== "undefined" && chrome.runtime && typeof chrome.runtime.sendMessage === "function";
    function sendToPET(payload, cb){
      if(!canUseAPI()){ say("Chrome API not available. Use Google Chrome on desktop.", false); cb?.(null); return; }
      try{
        chrome.runtime.sendMessage(EXT_ID, payload, (resp)=>{
          if(chrome.runtime.lastError){ say("Could not reach PET: "+chrome.runtime.lastError.message, false); cb?.(null); return; }
          cb?.(resp);
        });
      }catch(e){ say("Could not reach PET: "+(e?.message||e), false); cb?.(null); }
    }

    // ----- Pep lines -----
    const linesEl = document.getElementById('lines');
    document.getElementById('save').onclick=()=>{
      const lines = linesEl.value.split('\n').map(s=>s.trim()).filter(Boolean);
      if(!lines.length) return say("Add at least one line.", false);
      const last = lines[lines.length-1];
      sendToPET({ type:"PET_ADD_LINES", lines }, (r)=> {
        if(!r?.ok) return say("PET error: "+(r?.error||"Unknown"), false);
        sendToPET({ type:"PET_SAY_NOW", text:last });
        say(`Saved & said: ‚Äú${last}‚Äù`);
      });
    };
    document.getElementById('load').onclick=()=>{
      sendToPET({ type:"PET_GET_LINES" }, (r)=>{
        if(!r?.ok) return say("PET error: "+(r?.error||"Unknown"), false);
        linesEl.value = (r.lines||[]).join('\n'); say(`Connected. Load or add lines.`);
      });
    };

    // ----- Frequency -----
    const freqEl = document.getElementById('freq');
    document.getElementById('freqSave').onclick=()=>{
      const m = Math.max(1, parseInt(freqEl.value||'45',10));
      sendToPET({ type:"SET_FREQUENCY", minutes:m }, (r)=>{
        if(r?.ok) say(`Saved. PET will nudge every ${m} min.`);
        else say("Could not save frequency.", false);
      });
    };

    // ----- PET avatars ‚Äî 3x2, filled -----
    const PETS = [
      "brown_dog_nobg.png",
      "pet.png",                 // sausage dog (replaces icon128)
      "light_dog_nobg.png",
      "orange_hams_nobg.png",
      "orange_cat_nobg.png",
      "icon128_fixed.png"        // optional alt dog
    ];
    const petGrid = document.getElementById('petGrid');
    let currentAvatar = null;
    function renderPets(){
      petGrid.innerHTML = "";
      PETS.forEach(name=>{
        const btn = document.createElement('button');
        btn.className = 'petOpt' + (name===currentAvatar?' active':'');
        btn.setAttribute('role','option');
        btn.setAttribute('aria-selected', name===currentAvatar ? 'true':'false');
        const img = document.createElement('img');
        img.alt = name.replace(/[_-]/g,' ').replace(/\..+$/,'');
        // display images from your repo (page), selection only; extension loads from /assets inside the extension
        img.src = 'assets/' + name;
        btn.appendChild(img);
        btn.onclick = () => {
          currentAvatar = name;
          [...petGrid.children].forEach(c=>c.classList.remove('active'));
          btn.classList.add('active');
          sendToPET({ type:"SET_AVATAR", name });
        };
        petGrid.appendChild(btn);
      });
    }

    // ----- Pawprint chart -----
    function formatMin(sec){ return Math.round(sec/60) + 'm'; }
    function drawChart(weekly){
      const c = document.getElementById('chart');
      c.innerHTML = '';
      weekly.forEach(d=>{
        const bar = document.createElement('div'); bar.className='bar';
        const fill = document.createElement('span'); fill.style.height = Math.min(100, (d.seconds/60)) + '%';
        const label = document.createElement('div'); label.className='barLabel'; label.textContent = d.date.slice(5).replace('-','/');
        bar.appendChild(fill); bar.appendChild(label); c.appendChild(bar);
      });
    }

    // ----- Initial load -----
    sendToPET({ type:"GET_SETTINGS" }, (r)=>{
      if(!r?.ok) return;
      freqEl.value = r.minutes || 45;
      currentAvatar = r.avatar || PETS[0];
      renderPets();
      if (r.stats){
        document.getElementById('kToday').textContent   = formatMin(r.stats.todaySeconds);
        document.getElementById('k7').textContent       = formatMin(r.stats.weekly.reduce((a,b)=>a+b.seconds,0));
        document.getElementById('kStreak').textContent  = r.stats.currentStreak;
        document.getElementById('kLongest').textContent = r.stats.longestStreak;
        drawChart(r.stats.weekly);
      }
    });
  </script>
</body>
</html>

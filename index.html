<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PET Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --ink:#2b2118;
      --paper:#ffffffee;
      --bg-a:#fff4ea; --bg-b:#fde9f2; --bg-c:#e9fbf1;
      --peach:#ff8c7a; --teal:#3f8e7b;
      --shadow: 0 18px 50px rgba(60,38,21,.15), 0 4px 16px rgba(60,38,21,.08);
      --radius:22px;
      --muted:#6b5c52;
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font:16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg-a), var(--bg-b) 40%, var(--bg-c) 100%);
      overflow-x:hidden;
    }
    /* subtle drifting blobs */
    canvas#bg{ position:fixed; inset:0; z-index:0; pointer-events:none; }

    .wrap{
      position:relative; z-index:1;
      max-width: 900px;
      margin: clamp(18px, 6vh, 56px) auto;
      padding: clamp(18px, 3.8vw, 28px);
      border-radius: var(--radius);
      background: var(--paper);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
    }
    .header{ display:flex; align-items:center; gap:14px; margin-bottom:8px; }
    h1{ margin:0; font-size: clamp(22px, 2.6vw, 32px); letter-spacing:.2px; }
    .sub{ color:var(--muted); margin:0 0 14px; }

    .field{
      margin-top: 12px;
      border-radius: 16px;
      border:1px solid #e8d9cc;
      background:#fffdfb;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      overflow:hidden;
    }
    textarea{
      display:block; width:100%; min-height: 240px;
      padding:14px 14px 16px; border:0; outline:0; box-sizing:border-box;
      font: 15px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      background:transparent; color:var(--ink);
    }
    .row{ display:flex; flex-wrap:wrap; gap:12px; margin-top:14px; }
    .btn{
      --bg:#2b2118; --txt:#fff;
      appearance:none; border:0; cursor:pointer;
      padding:12px 16px; border-radius:14px; color:var(--txt); font-weight:650; letter-spacing:.15px;
      background: radial-gradient(120% 140% at 10% 10%, color-mix(in oklab, var(--bg), black 7%) 0 25%, var(--bg) 26% 100%);
      position:relative; transform: translateZ(0);
      transition: transform .06s ease, filter .25s ease, box-shadow .25s ease;
      box-shadow: 0 6px 18px rgba(43,33,24,.18), inset 0 1px 0 rgba(255,255,255,.2);
      overflow:hidden;
    }
    .btn:hover{ filter: brightness(1.06); box-shadow: 0 10px 28px rgba(43,33,24,.25), 0 0 24px 6px color-mix(in oklab, var(--bg), white 75%); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.peach{ --bg: var(--peach); }
    .btn.teal { --bg: var(--teal); }
    .btn.is-sending{ animation: throb .9s ease-in-out infinite; }
    @keyframes throb { 50% { transform: translateY(0) scale(1.03) } }
    .btn .r{ position:absolute; width:8px;height:8px;border-radius:999px; background:#fff8; transform: translate(-50%,-50%) scale(0); animation: ripple .6s ease-out; pointer-events:none; }
    @keyframes ripple{ to { transform: translate(-50%,-50%) scale(22); opacity:0 } }

    .hint{ font-size:13px; color:var(--muted); margin-top:8px;}
    .ok { color:#0f7d4c; }
    .err{ color:#b00020; }

    .badges{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; align-items:center; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; background:#fff8f1; border:1px solid #f2decf; color:#5c4a3c; border-radius: 999px; font-size:12px; }
    .dot{ width:10px;height:10px;border-radius:50%; background:#ffb39f; box-shadow:0 0 10px #ffb39f; }
    .dot.mint{ background:#a8e4d2; box-shadow:0 0 10px #a8e4d2; }

    /* Timer card */
    .timer-card{
      margin-top:16px; padding:16px; border:1px solid #eedfd3; border-radius:16px; background:#fffefa;
    }
    .timer-head{ display:flex; align-items:center; gap:8px; font-weight:700; color:#374151; }
    .timer-grid{ margin-top:12px; display:grid; grid-template-columns: 140px 1fr; gap:16px; align-items:center; }
    .dial{
      width:120px;height:120px;border-radius:50%;
      display:grid; place-items:center; background:#f4f1ed; color:#0f5132;
      border:1px solid #e6dbcf; box-shadow: inset 0 1px 0 #fff, 0 8px 20px rgba(0,0,0,.05);
      font-weight:800; font-size:20px;
    }
    .inputs{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .inputs label{ font-size:12px; color:#555; display:flex; flex-direction:column; gap:6px; }
    .inputs input{
      width:86px; padding:10px 12px; border-radius:12px; border:1px solid #e4d7c9; background:#fff; font-weight:700; text-align:center;
      box-shadow: 0 2px 0 #fff inset;
    }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{ padding:10px 12px; border-radius:12px; background:#fff; border:1px solid #e4d7c9; cursor:pointer; }
    .pill:active{ transform: translateY(1px); }
    .warn{ color:#b00020; font-size:12px; margin-top:6px; }

    /* ID helper (shown if wrong ID) */
    .idbar{
      display:none; margin-bottom:10px; padding:10px 12px; border-radius:12px; background:#fff2f2; border:1px solid #ffcccc; color:#7a1a1a;
    }
    .idbar.show{ display:block; }
    @media (max-width:560px){ .wrap{ margin:18px 12px } .timer-grid{ grid-template-columns: 1fr; } .dial{ margin:0 auto; } }
  </style>
</head>
<body>
  <canvas id="bg" aria-hidden="true"></canvas>

  <main class="wrap" role="main">
    <div class="header">
      <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 7h12M6 12h9M6 17h6" stroke="#2b2118" stroke-width="2" stroke-linecap="round"/></svg>
      <div>
        <h1>Welcome to PET Control Panel</h1>
        <p class="sub">PET aka Personal Empowerment Tool will cheer you on across your tabs.</p>
        <p class="sub">Instruction: Add pep lines below for your PET. One line per row.</p>
      </div>
    </div>

    <div id="idbar" class="idbar">
      Can‚Äôt reach the extension. Check your <b>EXT_ID</b> below matches the ID in <code>chrome://extensions</code> ‚Üí
      <input id="idInput" style="width:320px;margin-left:8px;padding:6px 8px;border-radius:8px;border:1px solid #e0cfc0" />
    </div>

    <div class="field">
      <textarea id="lines" placeholder="E.g.
Drink water. Breathe. Send that message.
Tiny step now, future you says thanks."></textarea>
    </div>

    <div class="row">
      <button id="save" class="btn peach">Save to PET ‚ú®</button>
      <button id="load" class="btn teal">Load from PET üçÉ</button>
    </div>

    <!-- Timer -->
    <section class="timer-card" aria-label="Timer">
      <div class="timer-head">‚è±Ô∏è Timer</div>
      <div class="timer-grid">
        <div class="dial"><span id="dial">00:00</span></div>
        <div class="inputs">
          <label>Hours   <input id="h" type="number" min="0" max="23" value="0"></label>
          <label>Minutes <input id="m" type="number" min="0" max="59" value="25"></label>
          <label>Seconds <input id="s" type="number" min="0" max="59" value="0"></label>
          <div class="controls">
            <button id="start" class="pill">Start</button>
            <button id="pause" class="pill">Pause</button>
            <button id="reset" class="pill">Reset</button>
            <button id="p5"   class="pill">5 min</button>
            <button id="p25"  class="pill">25 min</button>
          </div>
          <div class="warn" id="audioWarn" style="display:none">Note: most browsers require one click before sounds can play.</div>
        </div>
      </div>
    </section>

    <div id="status" class="hint" role="status" aria-live="polite"></div>
    <div class="badges">
      <span class="chip"><span class="dot"></span> Works in Google Chrome (desktop)</span>
      <span class="chip"><span class="dot mint"></span> Requires PET extension installed</span>
    </div>
  </main>

  <script>
    /* ======= soft drifting background ======= */
    const c = document.getElementById('bg'), ctx = c.getContext('2d');
    let blobs=[], DPR=window.devicePixelRatio||1;
    function size(){ c.width=innerWidth*DPR; c.height=innerHeight*DPR; ctx.setTransform(DPR,0,0,DPR,0,0);
      blobs = Array.from({length:10},(_,i)=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:80+Math.random()*160,h:[22,340,160][i%3],a:.22+.12*Math.random(),vx:(Math.random()-.5)*.25,vy:(Math.random()-.5)*.25}));
    } size(); addEventListener('resize',size);
    function loop(){ ctx.clearRect(0,0,innerWidth,innerHeight); for(const b of blobs){ b.x+=b.vx; b.y+=b.vy;
      if(b.x<-b.r) b.x=innerWidth+b.r; if(b.x>innerWidth+b.r) b.x=-b.r; if(b.y<-b.r) b.y=innerHeight+b.r; if(b.y>innerHeight+b.r) b.y=-b.r;
      const g=ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r); g.addColorStop(0,`hsla(${b.h} 92% 75% / ${b.a})`); g.addColorStop(1,`hsla(${b.h} 92% 75% / 0)`); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }
      requestAnimationFrame(loop);} loop();

    /* ======= PET wiring ======= */
    let EXT_ID = "libkjkfhpilbfmcbknhnhnfejacjkccd";  // <‚Äî Replace with YOUR current ID from chrome://extensions
    const idInput = document.getElementById('idInput'); idInput.value = EXT_ID;

    const statusEl = document.getElementById('status');
    const linesEl  = document.getElementById('lines');
    const saveBtn  = document.getElementById('save');
    const loadBtn  = document.getElementById('load');

    const canUseAPI = () =>
      typeof chrome !== "undefined" && chrome.runtime && typeof chrome.runtime.sendMessage === "function";

    function say(txt, ok=true){ statusEl.textContent = txt; statusEl.className = "hint " + (ok? "ok":"err"); }
    function ripple(e){ const r=document.createElement('span'); r.className='r'; e.currentTarget.appendChild(r); r.style.left=e.offsetX+'px'; r.style.top=e.offsetY+'px'; r.addEventListener('animationend',()=>r.remove()); }
    [saveBtn, loadBtn].forEach(b=>b.addEventListener('click', ripple));

    function sendToPET(payload, cb){
      if (!canUseAPI()) { say("Chrome API not available. Use Google Chrome on desktop.", false); cb?.(null); return; }
      chrome.runtime.sendMessage(EXT_ID, payload, (resp) => {
        if (chrome.runtime.lastError) {
          const msg = chrome.runtime.lastError.message || "";
          if (/No such extension|Receiving end does not exist/i.test(msg)) {
            // likely wrong ID
            document.getElementById('idbar').classList.add('show');
            say("Can't reach PET. Check the extension ID above.", false);
          } else {
            say("Could not reach PET: " + msg, false);
          }
          cb?.(null); return;
        }
        cb?.(resp);
      });
    }

    function getLines(){ return linesEl.value.split('\n').map(s=>s.trim()).filter(Boolean); }

    saveBtn.addEventListener('click', () => {
      EXT_ID = idInput.value.trim() || EXT_ID; // allow quick correction
      const lines = getLines();
      if (!lines.length) { say("Add at least one line.", false); return; }
      const sayNow = lines[lines.length - 1];
      saveBtn.classList.add('is-sending'); saveBtn.disabled = true;
      sendToPET({ type: "PET_ADD_LINES", lines }, (resp) => {
        saveBtn.classList.remove('is-sending'); saveBtn.disabled = false;
        if (!(resp && resp.ok)) { say("PET error: " + (resp?.error || "Unknown"), false); return; }
        sendToPET({ type: "PET_SAY_NOW", text: sayNow }, (r2) => {
          if (r2?.ok) { say(`Saved & said: ‚Äú${sayNow}‚Äù`); confetti(); }
          else { say("Saved, but could not trigger speech.", false); }
        });
      });
    });

    loadBtn.addEventListener('click', () => {
      EXT_ID = idInput.value.trim() || EXT_ID;
      loadBtn.classList.add('is-sending'); loadBtn.disabled = true;
      sendToPET({ type: "PET_GET_LINES" }, (resp) => {
        loadBtn.classList.remove('is-sending'); loadBtn.disabled = false;
        if (resp?.ok) { linesEl.value = (resp.lines || []).join('\n'); say(`Loaded ${resp.lines?.length || 0} lines from PET.`); }
        else { say("PET error: " + (resp?.error || "Unknown"), false); }
      });
    });

    window.addEventListener('DOMContentLoaded', () => {
      if (!canUseAPI()) { say("Chrome API not available. Use Google Chrome on desktop.", false); return; }
      sendToPET({ type: "PET_GET_LINES" }, (resp) => {
        if (resp?.ok) { linesEl.value = (resp.lines || []).join('\n'); say(`Connected to PET. ${resp.lines?.length || 0} custom lines loaded.`); }
        else { say("Could not connect to PET. Check the ID banner above.", false); document.getElementById('idbar').classList.add('show'); }
      });
    });

    function confetti(){
      const N=28;
      for(let i=0;i<N;i++){
        const s=document.createElement('div'), size = 6+Math.random()*8;
        s.textContent = ['‚ú®','üê∂','üåü','üíñ','üçÄ'][i%5];
        s.style.position='fixed'; s.style.zIndex=9999; s.style.left=(Math.random()*100)+'vw'; s.style.top='-10vh';
        s.style.fontSize=size+'px'; s.style.transition='transform 1.2s ease-out, opacity 1.2s ease-out';
        document.body.appendChild(s);
        requestAnimationFrame(()=>{ s.style.transform=`translateY(${110+Math.random()*20}vh) rotate(${(Math.random()-.5)*360}deg)`; s.style.opacity='0'; });
        setTimeout(()=>s.remove(),1300);
      }
    }

    /* ======= Timer ======= */
    const h=document.getElementById('h'), m=document.getElementById('m'), s=document.getElementById('s');
    const start=document.getElementById('start'), pause=document.getElementById('pause'), reset=document.getElementById('reset'), p5=document.getElementById('p5'), p25=document.getElementById('p25');
    const dial=document.getElementById('dial'), warn=document.getElementById('audioWarn');
    let remaining=0, t=null, audioUnlocked=false;

    const chime = new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA...'); // short gentle chime (inlined)
    function unlock(){ if(!audioUnlocked){ chime.play().then(()=>{chime.pause(); chime.currentTime=0; audioUnlocked=true;}).catch(()=>{ warn.style.display='block';}); } }
    ['click','touchstart'].forEach(ev=>document.addEventListener(ev,unlock,{once:true,passive:true}));

    function fmt(sec){ const mm = Math.floor(sec/60), ss = sec%60; return (mm<10?'0':'')+mm+':'+(ss<10?'0':'')+ss; }
    function updateDial(){ dial.textContent = fmt(remaining); }
    function compute(){ const hh=+h.value||0, mm=+m.value||0, ss=+s.value||0; return Math.max(0, Math.floor(hh*3600+mm*60+ss)); }

    function tick(){
      remaining--; updateDial();
      if (remaining<=0){ clearInterval(t); t=null; remaining=0; updateDial();
        chime.play().catch(()=>{});  // best effort
        sendToPET({ type:"PET_SAY_NOW", text:"Time‚Äôs up!" }, ()=>{});
      }
    }

    start.onclick = ()=>{ EXT_ID = idInput.value.trim() || EXT_ID; remaining = compute(); if(remaining<=0) return; if(t) clearInterval(t); t=setInterval(tick,1000); updateDial(); };
    pause.onclick = ()=>{ if(t){ clearInterval(t); t=null; } };
    reset.onclick = ()=>{ if(t){ clearInterval(t); t=null; } remaining=0; updateDial(); };
    p5.onclick = ()=>{ h.value=0; m.value=5; s.value=0; updateDial(); };
    p25.onclick= ()=>{ h.value=0; m.value=25; s.value=0; updateDial(); };
    updateDial();
  </script>
</body>
</html>

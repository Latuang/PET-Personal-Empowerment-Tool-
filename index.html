<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PET Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg-a:#fff4ea;--bg-b:#fde9f2;--bg-c:#e9fbf1;--ink:#2b2723;--ink-soft:#7b716a;--line:#d9cdc5;--line-strong:#cdbfb6;--accent:#2f8d7c;--accent-soft:#e8f3f0;--peach:#ffa191;--mint:#6cc7b3;--honey:#ffd674;--radius:14px;--shadow:0 10px 26px rgba(40,26,16,.10),0 2px 10px rgba(40,26,16,.06)}
    html,body{height:100%}body{margin:0;color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg-a),var(--bg-b) 45%,var(--bg-c) 100%);-webkit-font-smoothing:antialiased;overflow-x:hidden}
    .wrap{max-width:1080px;margin:clamp(16px,4vh,28px) auto;padding:14px;background:#fffdfb;border:1.5px solid var(--line);border-radius:18px;box-shadow:var(--shadow);display:grid;gap:12px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:8px}.title{display:flex;gap:10px;align-items:baseline}.title h1{margin:0;font-weight:800;font-size:clamp(18px,2.1vw,22px)}.subtitle{color:var(--ink-soft);font-size:12.5px}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.chip{display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:#fff;border:1.5px solid var(--line);box-shadow:0 2px 8px rgba(0,0,0,.05);font-weight:600}.chip input{width:58px;border:1.5px solid var(--line-strong);border-radius:8px;padding:6px;text-align:center;font:600 13px/1 system-ui;background:#fff}
    .btn{appearance:none;border:1.5px solid var(--line-strong);background:linear-gradient(#fff,#faf7f4);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700;color:#245e54;box-shadow:0 2px 8px rgba(0,0,0,.06)}.btn:active{transform:translateY(1px)}
    .grid{display:grid;gap:12px;grid-template-columns:1.05fr .95fr;min-height:0}@media (max-width:920px){.grid{grid-template-columns:1fr}}
    .card,.timer,.paw,.pets{background:#fffaf6;border:1.5px solid var(--line);border-radius:var(--radius);padding:12px}.card{display:grid;gap:8px;min-height:0}.card h2,.timer h2,.paw h2,.pets h2{margin:0;font-size:15px;display:flex;align-items:center;gap:6px}
    .field{border:1.5px solid var(--line-strong);background:#fff;border-radius:12px;overflow:hidden;box-shadow:inset 0 1px 0 rgba(0,0,0,.04)}textarea{width:100%;min-height:138px;max-height:190px;resize:vertical;border:0;outline:0;padding:10px 12px 12px;background:#fff;color:var(--ink);font:13px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.btn.peach{color:#6b2b24;background:linear-gradient(#fff,#fff) padding-box,linear-gradient(90deg,#ffb6a9,#ffc6c6) border-box;border:1.5px solid transparent}.btn.mint{color:#20584d;background:linear-gradient(#fff,#fff) padding-box,linear-gradient(90deg,#b8ece2,#c7f2eb) border-box;border:1.5px solid transparent}.status{margin-left:auto;color:#0f7d4c;font-size:12px}
    .timer{display:grid;gap:10px;grid-template-rows:auto auto auto}.lcd{margin:2px auto 4px;border:1.5px solid var(--line-strong);background:linear-gradient(180deg,#fff7c5,#ffe38c);color:#1e1a14;font:800 26px/1 "JetBrains Mono",ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;letter-spacing:1.5px;padding:10px 12px 8px;border-radius:10px;min-width:140px;text-align:center;box-shadow:inset 0 1px 0 #fffbe0,inset 0 -2px 0 #e7c86a}
    .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}.pill{padding:8px 10px;border-radius:10px;border:1.5px solid var(--line-strong);background:#fff;cursor:pointer;font-weight:700;box-shadow:0 1px 6px rgba(0,0,0,.06)}.pill.start{background:#e7faf4;color:#24695d}.pill.pause{background:#fff0ed;color:#7a3c34}.pill.reset{background:#fff8df;color:#6d5a23}
    .inputs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.ibox{background:#fff;border:1.5px solid var(--line-strong);border-radius:10px;padding:6px;text-align:center}.ibox label{display:block;font-size:11px;color:var(--ink-soft)}.ibox input{width:100%;border:0;outline:0;background:transparent;font:700 16px/1.2 ui-monospace,Menlo,Consolas;text-align:center}
    .paw .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.stat{background:#fff;border:1.5px solid var(--line-strong);border-radius:12px;padding:10px;text-align:center}.chart{margin-top:8px;background:#fff;border:1.5px dashed var(--line-strong);border-radius:12px;padding:12px;height:110px;display:flex;gap:14px;align-items:flex-end;justify-content:space-between}
    .bar{flex:1;min-width:16px;display:flex;flex-direction:column;align-items:center;gap:6px}.bar span{display:block;width:100%;height:10px;background:#dff0ea;border:1.5px solid #c7e3db;border-radius:10px}.bar span.fill{background:#bfe5d7}.bar .lbl{font-size:11.5px;color:#6d6b66}
    .pets-grid{display:grid;grid-template-columns:repeat(3,120px);grid-auto-rows:120px;gap:10px;justify-content:start}.pet-tile{display:flex;align-items:center;justify-content:center;background:#fff;border:1.5px solid var(--line-strong);border-radius:12px;cursor:pointer;transition:transform .05s ease}.pet-tile:active{transform:translateY(1px)}.pet-tile img{width:86px;height:86px;object-fit:contain;image-rendering:-webkit-optimize-contrast}.pet-tile.sel{outline:3px solid #2f8d7c;box-shadow:0 0 0 2px #cfeae6 inset}
    .mini{font-size:12px;color:#7d8b84}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>PET Control Panel</h1>
        <div class="subtitle">Personal Empowerment Tool</div>
      </div>
      <div class="toolbar">
        <div class="chip">Talk every <input id="period" type="number" min="1" value="45"> min</div>
        <button id="savePeriod" class="btn">Save</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üí¨ Pep Lines</h2>
        <div class="field"><textarea id="lines" placeholder="One line per row
e.g. Tiny step now‚Äîfuture you says thanks."></textarea></div>
        <div class="row">
          <button id="saveLines" class="btn peach">Save to PET ‚ú®</button>
          <div id="status" class="status"></div>
        </div>
      </div>

      <div class="timer">
        <h2>‚è±Ô∏è Focus Timer</h2>
        <div class="lcd" id="lcd">25:00</div>
        <div class="actions">
          <button id="start" class="pill start">Start</button>
          <button id="pause" class="pill pause">Pause</button>
          <button id="reset" class="pill reset">Reset</button>
          <button id="m5" class="pill">5m</button>
          <button id="m25" class="pill">25m</button>
        </div>
        <div class="inputs">
          <div class="ibox"><label>Hours</label><input id="h" type="number" value="0" min="0"></div>
          <div class="ibox"><label>Minutes</label><input id="m" type="number" value="25" min="0"></div>
          <div class="ibox"><label>Seconds</label><input id="s" type="number" value="0" min="0"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="paw">
        <h2>üêæ Progress Pawprint</h2>
        <div class="stats">
          <div class="stat"><b id="today">0m</b><span class="mini">Today</span></div>
          <div class="stat"><b id="week">0m</b><span class="mini">Last 7 days</span></div>
          <div class="stat"><b id="streak">0 days</b><span class="mini">Current Streak</span></div>
          <div class="stat"><b id="longest">0 days</b><span class="mini">Longest Streak</span></div>
        </div>
        <div id="chart" class="chart"></div>
      </div>

      <div class="pets">
        <h2>üß∏ Choose Your PET</h2>
        <div id="pets" class="pets-grid"></div>
      </div>
    </div>
  </div>

<script>
  // ---- bridge keys + helpers ----
  const SESSIONS_KEY = 'petSessions';
  const PET_AVATAR   = 'petAvatar';
  const PERIOD_KEY   = 'periodMinutes';
  const PET_LINES    = 'petCustomLines';

  const qs = (id) => document.getElementById(id);
  const statusEl = qs('status');
  const linesEl  = qs('lines');

  const setStatus = (msg, ok=true)=>{ statusEl.textContent = msg||''; statusEl.style.color = ok ? '#0f7d4c' : '#b22626'; if (msg) setTimeout(()=> setStatus(''), 2200); };
  const lsGet = (k,f)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? f;}catch{return f;} };
  const lsSet = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

  // ---------- pep lines (via bridge) ----------
  qs('saveLines').addEventListener('click', () => {
    const lines = linesEl.value.split('\n').map(s=>s.trim()).filter(Boolean);
    lsSet(PET_LINES, lines); // fallback copy for the website
    window.postMessage({ type: 'PET_ADD_LINES', lines }, '*');
    window.postMessage({ type: 'PET_SAY_NOW', text: lines.at(-1) || 'You\'ve got this.' }, '*');
    setStatus('Saved. PET will nudge with your lines.');
  });

  // Removed loadLines functionality completely

  // ---------- timer ----------
  let countdown = null, remaining = 1500;
  const lcd = qs('lcd'), hIn = qs('h'), mIn = qs('m'), sIn = qs('s');
  function fmt(sec){ const m=Math.floor(sec/60), s=sec%60; return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  function syncInputsToRemaining(){ const h=Math.floor(remaining/3600), m=Math.floor((remaining%3600)/60), s=remaining%60; hIn.value=h; mIn.value=m; sIn.value=s; lcd.textContent=fmt(remaining); }
  function recalcFromInputs(){ const h=Math.max(0,parseInt(hIn.value||'0',10)), m=Math.max(0,parseInt(mIn.value||'0',10)), s=Math.max(0,parseInt(sIn.value||'0',10)); remaining=h*3600+m*60+s; lcd.textContent=fmt(remaining); }
  [hIn,mIn,sIn].forEach(el=> el.addEventListener('change', recalcFromInputs));
  function tick(){ if(remaining>0){ remaining--; lcd.textContent=fmt(remaining);} else { stopTimer(); finishSession(); } }
  function startTimer(){ stopTimer(); recalcFromInputs(); if (remaining<=0) remaining = 1500; countdown=setInterval(tick,1000); }
  function stopTimer(){ if(countdown){ clearInterval(countdown); countdown=null; } }
  function resetTimer(){ stopTimer(); remaining=1500; syncInputsToRemaining(); }
  function setQuick(min){ hIn.value=0; mIn.value=min; sIn.value=0; recalcFromInputs(); }
  qs('start').addEventListener('click', startTimer);
  qs('pause').addEventListener('click', stopTimer);
  qs('reset').addEventListener('click', resetTimer);
  qs('m5').addEventListener('click', ()=> setQuick(5));
  qs('m25').addEventListener('click',()=> setQuick(25));
  syncInputsToRemaining();

  function finishSession(){
    const seconds = Math.max(1, parseInt(hIn.value||'0',10)*3600 + parseInt(mIn.value||'0',10)*60 + parseInt(sIn.value||'0',10));
    addSession(seconds);
    
    // ONLY send timer complete - no random lines
    window.postMessage({ type: 'PET_TIMER_COMPLETE' }, '*');
    
    setStatus('Nice! Session added.');
    resetTimer();
  }

  // ---------- progress pawprint ----------
  function startOfDay(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.getTime(); }
  function dayKey(ts){ return new Date(startOfDay(ts)).toISOString().slice(0,10); }
  function addSession(seconds, atMs=Date.now()){
    const local = lsGet(SESSIONS_KEY, []);
    local.push({ ts: Math.floor(atMs/1000), seconds: Math.max(1, Math.floor(seconds)) });
    lsSet(SESSIONS_KEY, local.slice(-2000));
    window.postMessage({ type:'PET_ADD_SESSION', seconds: Math.max(1, Math.floor(seconds)) }, '*');
    updateStatsFromStores();
  }
  function computeStats(sessions){
    const now = Date.now(), todayStart = startOfDay(now);
    let today = 0, week = 0;
    const perDay = new Map();
    for (const s of sessions){
      const ms = s.ts*1000; const key = dayKey(ms);
      perDay.set(key, (perDay.get(key)||0)+s.seconds);
      if (ms>=todayStart) today += s.seconds;
    }
    const days = [];
    for (let i=6;i>=0;i--){
      const d = new Date(todayStart - i*86400000);
      const key = d.toISOString().slice(0,10);
      const sec = perDay.get(key)||0; week += sec;
      days.push({ date: d.toLocaleDateString(undefined,{weekday:'short'}), minutes: Math.round(sec/60) });
    }
    let streak=0, longest=0, cursor=todayStart;
    while ((perDay.get(dayKey(cursor))||0) > 0) { streak++; cursor -= 86400000; longest = Math.max(longest, streak); }
    return { today:Math.round(today/60), week:Math.round(week/60), streak, longest, bars: days };
  }
  function renderStats(st){
    qs('today').textContent   = (st.today||0) + 'm';
    qs('week').textContent    = (st.week||0) + 'm';
    qs('streak').textContent  = (st.streak||0) + ' days';
    qs('longest').textContent = (st.longest||0) + ' days';
    const chart = qs('chart'); chart.innerHTML='';
    for (const d of st.bars){
      const bar = document.createElement('div'); bar.className='bar';
      const span = document.createElement('span'); if (d.minutes>0) span.classList.add('fill');
      span.style.height = (8 + Math.min(100, d.minutes)) + 'px';
      const lbl = document.createElement('div'); lbl.className='lbl'; lbl.textContent = `${d.date} ¬∑ ${d.minutes}m`;
      bar.appendChild(span); bar.appendChild(lbl); chart.appendChild(bar);
    }
  }
  function updateStatsFromStores(){ renderStats(computeStats(lsGet('petSessions', []))); }
  updateStatsFromStores();

  // ---------- period (nudge frequency) ----------
  const periodEl = qs('period'); periodEl.value = lsGet(PERIOD_KEY, 45);
  qs('savePeriod').addEventListener('click', ()=>{
    const val = Math.max(1, parseInt(periodEl.value||'45',10));
    lsSet(PERIOD_KEY, val);
    window.postMessage({ type:'PET_RESCHEDULE' }, '*');
    setStatus('Saved. PET will nudge every '+val+' min.');
  });

  // ---------- avatar chooser ----------
  const PETS = [
    { file:'brown_dog_nobg.png',   label:'Brown pup' },
    { file:'pet.png',              label:'Sausage dog' },
    { file:'light_dog_nobg.png',   label:'Light pup' },
    { file:'orange_hams_nobg.png', label:'Hamster' },
    { file:'orange_cat_nobg.png',  label:'Orange cat' }
  ];
  const petGrid = qs('pets');
  function markSelected(tile){ [...petGrid.children].forEach(c=>c.classList.remove('sel')); tile.classList.add('sel'); }
  function renderPets(saved){
    petGrid.innerHTML='';
    PETS.forEach(p=>{
      const div=document.createElement('div'); div.className='pet-tile';
      const img=document.createElement('img'); img.alt=p.label;
      const name=p.file;
      img.src = `./${name}`; // repo root first
      img.onerror = () => { img.onerror = null; img.src = `chrome-extension://libkjkfhpilbfmcbknhnhnfejacjkccd/assets/${name}`; };
      div.appendChild(img);
      if (p.file===saved) markSelected(div);
      div.addEventListener('click', ()=>{
        markSelected(div);
        lsSet(PET_AVATAR, p.file);
        window.postMessage({ type:'PET_SET_AVATAR', file:p.file }, '*');
      });
      petGrid.appendChild(div);
    });
  }
  renderPets(lsGet(PET_AVATAR, PETS[0].file));
</script>
</body>
</html>

<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PET Control Panel</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body { font: 16px system-ui; margin: 0; background: #f7f7f8; color: #111; }
      .wrap { max-width: 720px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,.08); }
      h1 { margin: 0 0 8px; font-size: 24px; }
      p  { margin: 0 0 16px; color: #444; }
      textarea { width: 100%; min-height: 180px; font: 15px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .row { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
      button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: #111; color: #fff; cursor: pointer; }
      button.secondary { background: #fff; color: #111; }
      .hint { font-size: 13px; color: #666; margin-top: 8px; }
      .ok { color: #0a7f2e; }
      .err { color: #b00020; }
    </style>
  </head>
  <body> 
    <div class="wrap">
      <h1>PET Control Panel</h1>
      <p>Add custom pep lines for your PET. One line per row.</p>

      <textarea id="lines" placeholder="E.g.&#10;Press startâ€”two minutes only.&#10;Drink water. Breathe. Send that message."></textarea>

      <div class="row">
        <button id="save">Save to PET</button>
        <button class="secondary" id="load">Load from PET</button>
      </div>

      <div id="status" class="hint"></div>
      <div class="hint">Note: Works only in Chrome with the PET extension installed and this site whitelisted in the extension manifest.</div>
    </div>

    <script>
      // 1) Replace with your real extension ID (from chrome://extensions)
      const EXT_ID = "libkjkfhpilbfmcbknhnhnfejacjkccd";

      // 2) Helper refs
      const statusEl = document.getElementById('status');
      const linesEl  = document.getElementById('lines');

      function showStatus(msg, ok = true) {
        statusEl.textContent = msg;
        statusEl.className = "hint " + (ok ? "ok" : "err");
      }

      function getLinesFromTextarea() {
        return linesEl.value.split('\n').map(s => s.trim()).filter(Boolean);
      }

      function canUseAPI() {
        return typeof chrome !== "undefined" && !!chrome.runtime?.sendMessage;
      }

      function sendToPET(payload, cb) {
        if (!canUseAPI()) {
          showStatus("This page must be opened in Chrome with the PET extension installed.", false);
          return;
        }
        chrome.runtime.sendMessage(EXT_ID, payload, (resp) => {
          if (chrome.runtime.lastError) {
            showStatus("Could not reach PET: " + chrome.runtime.lastError.message, false);
            cb?.(null);
            return;
          }
          cb?.(resp);
        });
      }

      // Save
      document.getElementById('save').addEventListener('click', () => {
        const lines = getLinesFromTextarea();
        if (!lines.length) { showStatus("Add at least one line.", false); return; }
        sendToPET({ type: "PET_ADD_LINES", lines }, (resp) => {
          if (resp?.ok) showStatus(`Saved! PET now has ${resp.count} custom lines.`);
          else showStatus("PET error: " + (resp?.error || "Unknown"), false);
        });
      });

      // Load
      document.getElementById('load').addEventListener('click', () => {
        sendToPET({ type: "PET_GET_LINES" }, (resp) => {
          if (resp?.ok) {
            linesEl.value = (resp.lines || []).join('\n');
            showStatus(`Loaded ${resp.lines?.length || 0} lines from PET.`);
          } else {
            showStatus("PET error: " + (resp?.error || "Unknown"), false);
          }
        });
      });

      // Prefill on page load + verify connectivity
      window.addEventListener('DOMContentLoaded', () => {
        if (!canUseAPI()) {
          showStatus("Chrome API not available. Open this page in Chrome on desktop.", false);
          return;
        }
        sendToPET({ type: "PET_GET_LINES" }, (resp) => {
          if (resp?.ok) {
            linesEl.value = (resp.lines || []).join('\n');
            showStatus(`Connected to PET. ${resp.lines?.length || 0} custom lines loaded.`);
          } else {
            showStatus("Could not connect to PET. Check that this site is whitelisted in the extension manifest.", false);
          }
        });
      });
    </script>
  </body>
</html>

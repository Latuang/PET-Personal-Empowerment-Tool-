<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PET Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* â€¦ (everything you already have stays the same) â€¦ */

    /* --- NEW: Pet gallery styles (small, neat) --- */
    .pets { background:#fffaf6; border:1.5px solid var(--line); border-radius: var(--radius); padding:12px; display:grid; gap:10px; }
    .pets h2 { margin:0; font-size:15px }
    .petGrid { display:grid; grid-template-columns: repeat(9,1fr); gap:8px; }
    @media (max-width: 920px){ .petGrid{ grid-template-columns: repeat(6,1fr);} }
    @media (max-width: 520px){ .petGrid{ grid-template-columns: repeat(4,1fr);} }

    .petOpt {
      aspect-ratio: 1/1; border:1.5px solid var(--line-strong); border-radius:10px;
      background:#fff center/contain no-repeat; cursor:pointer;
      box-shadow: 0 1px 6px rgba(0,0,0,.06);
      transition: transform .05s;
    }
    .petOpt:hover { transform: translateY(-1px); }
    .petOpt.sel { outline: 2px solid var(--accent); outline-offset: 2px; }

    .petControls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .petPreview {
      width:40px; height:40px; border-radius:8px; border:1.5px solid var(--line-strong);
      background:#fff center/contain no-repeat;
    }
    .petToggle { display:flex; gap:6px; align-items:center; font-size:12px; color:var(--ink-soft); }
    .petToggle input{ width:16px; height:16px; }
  </style>
</head>
<body>
  <main class="wrap">
    <!-- top bar â€¦ unchanged -->

    <div class="grid">
      <div class="left">
        <!-- Pep lines â€¦ unchanged -->

        <!-- Progress Pawprint â€¦ unchanged -->

        <!-- NEW: Choose Your PET -->
        <section class="pets" aria-label="Choose pet avatar">
          <h2>ðŸ§¸ Choose Your PET</h2>
          <div class="petGrid" id="petGrid"></div>
          <div class="petControls">
            <div class="petToggle">
              <input id="removeBg" type="checkbox" checked>
              <label for="removeBg">Remove white background automatically</label>
            </div>
            <div class="petPreview" id="petPreview" title="Current selection"></div>
            <button id="applyPet" class="btn">Apply</button>
          </div>
        </section>
      </div>

      <!-- Right column (Timer) â€¦ unchanged -->
      <div class="right">
        <!-- timer card you already have -->
      </div>
    </div>
  </main>

  <script>
    /* ===== everything you already had above stays the same (pep lines, frequency, timer, pawprint) ===== */

    // ---------- NEW: PET Gallery ----------
    // 9 pets (filenames from your folder screenshot)
    const PET_FILES = [
      "capy_pet.png", "orange_hams.png", "grey_hams.png",
      "orange_cat.png", "light_cat.png", "light_dog.png",
      "brown_dog.png", "panda.png", "icon128_fixed.png"
    ];

    const petGrid = document.getElementById('petGrid');
    const removeBgChk = document.getElementById('removeBg');
    const petPreview = document.getElementById('petPreview');
    const applyBtn = document.getElementById('applyPet');

    let currentName = PET_FILES[0];
    let currentDataUrl = null;

    // Build grid (these images live next to your index.html)
    PET_FILES.forEach((name, i) => {
      const cell = document.createElement('button');
      cell.className = 'petOpt' + (i===0 ? ' sel' : '');
      cell.style.backgroundImage = `url("${name}")`;
      cell.title = name.replace('.png','').replaceAll('_',' ');
      cell.addEventListener('click', () => {
        [...petGrid.children].forEach(c => c.classList.remove('sel'));
        cell.classList.add('sel');
        currentName = name;
        // show raw preview first; dataUrl generated on Apply
        petPreview.style.backgroundImage = `url("${name}")`;
        currentDataUrl = null;
      });
      petGrid.appendChild(cell);
    });

    // Convert white-ish pixels to transparent and return dataURL
    function removeWhiteBgToDataUrl(imgEl) {
      const w = imgEl.naturalWidth, h = imgEl.naturalHeight;
      const C = document.createElement('canvas'); C.width = w; C.height = h;
      const ctx = C.getContext('2d');
      ctx.drawImage(imgEl, 0, 0);
      const img = ctx.getImageData(0,0,w,h);
      const d = img.data;
      const TH = 246;        // anything >= this considered white-ish
      const RANGE = 18;      // allow tiny variance
      for (let i=0; i<d.length; i+=4) {
        const r=d[i], g=d[i+1], b=d[i+2];
        if (r>=TH && g>=TH && b>=TH && Math.max(r,g,b) - Math.min(r,g,b) < RANGE) {
          d[i+3]=0; // transparent
        }
      }
      ctx.putImageData(img,0,0);
      return C.toDataURL('image/png');
    }

    async function buildAvatarDataUrl(name, removeBg=true) {
      // Load image relative to this page
      const img = new Image();
      img.crossOrigin = 'anonymous'; // ensure canvas use
      img.src = name;
      await img.decode();
      if (removeBg) {
        return removeWhiteBgToDataUrl(img);
      } else {
        // just convert to PNG data URL as-is (keeps transparency if present)
        const C = document.createElement('canvas'); C.width = img.naturalWidth; C.height = img.naturalHeight;
        C.getContext('2d').drawImage(img,0,0);
        return C.toDataURL('image/png');
      }
    }

    applyBtn.addEventListener('click', async () => {
      try{
        // cache the preview dataURL
        const dataUrl = currentDataUrl || await buildAvatarDataUrl(currentName, removeBgChk.checked);
        petPreview.style.backgroundImage = `url("${dataUrl}")`;
        currentDataUrl = dataUrl;

        // Send to the extension so content script can use it everywhere
        sendToPET({ type: "SET_PET_IMAGE", name: currentName, dataUrl }, (r)=>{
          say(r?.ok ? "Pet avatar updated!" : "Could not update pet avatar", !!r?.ok);
        });
      }catch(e){
        say("Failed to process image: " + (e?.message||e), false);
      }
    });

    // On load, ask extension for current avatar to prime preview
    sendToPET({ type: "GET_PET_IMAGE" }, (r)=>{
      if (r?.dataUrl) petPreview.style.backgroundImage = `url("${r.dataUrl}")`;
      else petPreview.style.backgroundImage = `url("${PET_FILES[0]}")`;
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PET Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --ink:#2b2118;
      --paper:#ffffffee;
      --bg-a:#fff4ea;     /* warm peach */
      --bg-b:#fde9f2;     /* rosy milk */
      --bg-c:#e9fbf1;     /* mint foam */
      --peach:#ff8c7a;    /* Save */
      --teal:#3f8e7b;     /* Load */
      --radius:22px;
      --shadow:0 18px 50px rgba(60,38,21,.15), 0 4px 16px rgba(60,38,21,.08);
    }

    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font:16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, var(--bg-a), var(--bg-b) 40%, var(--bg-c) 100%);
      overflow-x:hidden;
    }

    /* subtle animated background dots */
    .fireflies{position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(6px 6px at 12% 70%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(5px 5px at 60% 20%, rgba(255,255,255,.5), transparent 60%),
        radial-gradient(4px 4px at 80% 80%, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(6px 6px at 30% 35%, rgba(255,255,255,.55), transparent 60%);
      animation: twinkle 6s ease-in-out infinite alternate;
      mix-blend-mode: screen; opacity:.55;
    }
    @keyframes twinkle{0%{filter:blur(.6px)}100%{filter:blur(1.3px) brightness(1.15)}}

    .wrap{
      position:relative; z-index:1;
      max-width: 860px;
      margin: clamp(18px, 6vh, 56px) auto;
      padding: clamp(18px, 3.8vw, 28px);
      border-radius: var(--radius);
      background: var(--paper);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
    }

    .header{ display:flex; align-items:center; gap:14px; margin:0 0 8px; }
    h1{ margin:0; font-size: clamp(22px, 2.6vw, 32px); letter-spacing:.2px; }
    .sub{ color:#6b5c52; margin:.25rem 0; }

    /* perfectly aligned editor */
    .field{
      margin-top: 12px;
      border-radius: 16px;
      border:1px solid #e8d9cc;
      background:#fffdfb;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      overflow:hidden;
    }
    textarea{
      display:block; width:100%; min-height:240px;
      padding:14px 14px 16px; border:0; outline:0; box-sizing:border-box;
      font: 15px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
      background:transparent; color:var(--ink);
    }

    .row{ display:flex; flex-wrap:wrap; gap:12px; margin-top:14px; }
    .btn{
      --bg:#2b2118; --txt:#fff;
      appearance:none; border:0; cursor:pointer;
      padding:12px 16px; border-radius:14px;
      color:var(--txt); font-weight:650; letter-spacing:.15px;
      background: radial-gradient(120% 140% at 10% 10%, color-mix(in oklab, var(--bg), black 7%) 0 25%, var(--bg) 26% 100%);
      transition: transform .06s ease, filter .25s ease, box-shadow .25s ease;
      box-shadow: 0 6px 18px rgba(43,33,24,.18), inset 0 1px 0 rgba(255,255,255,.2);
      position:relative; overflow:hidden;
    }
    .btn:hover{ filter:brightness(1.06); box-shadow:0 10px 28px rgba(43,33,24,.25), 0 0 24px 6px color-mix(in oklab, var(--bg), white 75%); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.peach{ --bg: var(--peach); }
    .btn.teal { --bg: var(--teal); }
    .btn .r{ position:absolute; width:8px;height:8px;border-radius:999px; background:#fff8;
      transform: translate(-50%,-50%) scale(0); animation:ripple .6s ease-out; pointer-events:none;}
    @keyframes ripple{to{transform:translate(-50%,-50%) scale(22); opacity:0}}

    .hint{ font-size:13px; color:#6b5c52; margin-top:8px;}
    .ok { color:#0f7d4c; }
    .err{ color:#b00020; }

    /* Timer card */
    .timer-card{
      margin-top:18px; padding:18px; border-radius:16px;
      background:#fffaf6; border:1px solid #f2decf;
    }
    .timer-head{ display:flex; align-items:center; gap:8px; margin-bottom:10px; font-weight:700;}
    .clock{
      width:110px; height:110px; border-radius:50%;
      background:linear-gradient(#fff,#fff8); border:1px solid #efd7c7;
      display:grid; place-items:center; font-weight:800; color:#2b2118;
      box-shadow: inset 0 8px 24px rgba(0,0,0,.03);
    }
    .time-inputs{ display:flex; gap:10px; align-items:end; flex-wrap:wrap; }
    .time-inputs label{ display:grid; gap:6px; font-size:12px; color:#6b5c52; }
    .time-inputs input{
      width:90px; padding:10px 12px; border-radius:12px; border:1px solid #ecd6c7; background:#fff;
      font-weight:700; text-align:center;
    }
    .timer-buttons{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .micro{ font-size:12px; color:#b04; display:none; margin-top:8px;}

    @media (max-width:560px){
      .wrap{ margin:18px 12px }
      .clock{ width:92px; height:92px }
      .time-inputs input{ width:80px }
    }
  </style>
</head>
<body>
  <div class="fireflies" aria-hidden="true"></div>

  <main class="wrap" role="main">
    <div class="header">
      <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M6 7h12M6 12h9M6 17h6" stroke="#2b2118" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div>
        <h1>Welcome to PET Control Panel</h1>
        <p class="sub">PET aka Personal Empowerment Tool will cheer you on across your tabs.</p>
        <p class="sub">Instruction: Add pep lines below for your PET. One line per row.</p>
      </div>
    </div>

    <div class="field">
      <textarea id="lines" placeholder="E.g.
Drink water. Breathe. Send that message.
Tiny step now, future you says thanks."></textarea>
    </div>

    <div class="row">
      <button id="save" class="btn peach">Save to PET ‚ú®</button>
      <button id="load" class="btn teal">Load from PET üçÉ</button>
    </div>

    <!-- Timer -->
    <section class="timer-card" aria-label="Timer">
      <div class="timer-head">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 2h8M12 8v5l3 2M6.5 6.5l-1 1M17.5 6.5l1 1" stroke="#2b2118" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        Timer
      </div>

      <div class="row" style="align-items:center">
        <div class="clock"><span id="readout">00:00</span></div>

        <div class="time-inputs">
          <label>Hours <input id="h" type="number" min="0" step="1" value="0"></label>
          <label>Minutes <input id="m" type="number" min="0" step="1" value="25"></label>
          <label>Seconds <input id="s" type="number" min="0" step="1" value="0"></label>
        </div>

        <div class="timer-buttons">
          <button id="start" class="btn peach">Start</button>
          <button id="pause" class="btn teal">Pause</button>
          <button id="reset" class="btn" style="--bg:#8b6b5a">Reset</button>
          <button data-preset="300" class="btn" style="--bg:#e7b08a">5 min</button>
          <button data-preset="1500" class="btn" style="--bg:#b3d2c6">25 min</button>
        </div>
      </div>

      <div id="audioHint" class="micro">Note: most browsers need one click (Start) before sounds can play.</div>
    </section>

    <div id="status" class="hint" role="status" aria-live="polite"></div>

    <div class="row" style="gap:10px; flex-wrap:wrap">
      <span class="hint" style="padding:.5rem .8rem; background:#fff8f1; border:1px solid #f2decf; border-radius:999px">Works in Google Chrome (desktop)</span>
      <span class="hint" style="padding:.5rem .8rem; background:#f5fffb; border:1px solid #d7efe6; border-radius:999px">Requires PET extension installed</span>
    </div>
  </main>

  <script>
    /* ===== PET wiring ===== */
    const EXT_ID = "libkjkfhpilbfmcbknhnhnfejacjkccd";
    const statusEl = document.getElementById('status');
    const linesEl  = document.getElementById('lines');
    const saveBtn  = document.getElementById('save');
    const loadBtn  = document.getElementById('load');

    const canUseAPI = () =>
      typeof chrome !== "undefined" && chrome.runtime && typeof chrome.runtime.sendMessage === "function";

    const say = (txt, ok=true)=>{ statusEl.textContent = txt; statusEl.className = "hint " + (ok? "ok":"err"); };
    const getLines = () => linesEl.value.split('\n').map(s => s.trim()).filter(Boolean);

    function sendToPET(payload, cb) {
      if (!canUseAPI()) { say("Chrome API not available. Use Google Chrome on desktop.", false); cb?.(null); return; }
      chrome.runtime.sendMessage(EXT_ID, payload, (resp) => {
        if (chrome.runtime.lastError) { say("Could not reach PET: " + chrome.runtime.lastError.message, false); cb?.(null); return; }
        cb?.(resp);
      });
    }

    function ripple(e){
      const r=document.createElement('span'); r.className='r';
      e.currentTarget.appendChild(r); r.style.left=e.offsetX+'px'; r.style.top=e.offsetY+'px';
      r.addEventListener('animationend', ()=>r.remove());
    }
    [saveBtn, loadBtn].forEach(b=>b.addEventListener('click', ripple));

    function confetti(){
      const N=32;
      for(let i=0;i<N;i++){
        const s=document.createElement('div'), size=6+Math.random()*8;
        s.textContent=['‚ú®','üê∂','üåü','üíñ','üçÄ'][i%5];
        Object.assign(s.style,{position:'fixed',zIndex:9999,left:(Math.random()*100)+'vw',top:'-10vh',fontSize:size+'px',transition:'transform 1.2s ease-out, opacity 1.2s ease-out'});
        document.body.appendChild(s);
        requestAnimationFrame(()=>{ s.style.transform=`translateY(${110+Math.random()*20}vh) rotate(${(Math.random()-.5)*360}deg)`; s.style.opacity='0'; });
        setTimeout(()=>s.remove(),1300);
      }
    }

    saveBtn.addEventListener('click', () => {
      const lines = getLines();
      if (!lines.length) { say("Add at least one line.", false); return; }
      const sayNow = lines[lines.length - 1];
      sendToPET({ type: "PET_ADD_LINES", lines }, (resp) => {
        if (!(resp && resp.ok)) { say("PET error: " + (resp?.error || "Unknown"), false); return; }
        sendToPET({ type: "PET_SAY_NOW", text: sayNow }, (r2) => {
          if (r2?.ok) { say(`Saved & said: ‚Äú${sayNow}‚Äù`); confetti(); }
          else { say("Saved, but could not trigger speech.", false); }
        });
      });
    });

    loadBtn.addEventListener('click', () => {
      sendToPET({ type: "PET_GET_LINES" }, (resp) => {
        if (resp?.ok) { linesEl.value = (resp.lines || []).join('\n'); say(`Loaded ${resp.lines?.length || 0} lines from PET.`); }
        else { say("PET error: " + (resp?.error || "Unknown"), false); }
      });
    });

    window.addEventListener('DOMContentLoaded', () => {
      if (!canUseAPI()) { say("Chrome API not available. Use Google Chrome on desktop.", false); return; }
      sendToPET({ type: "PET_GET_LINES" }, (resp) => {
        if (resp?.ok) { linesEl.value = (resp.lines || []).join('\n'); say(`Connected to PET. ${resp.lines?.length || 0} custom lines loaded.`); }
        else { say("Could not connect to PET. Check manifest origins and reload the extension.", false); }
      });
    });

    /* ===== Timer with cute chime ===== */
    const readout = document.getElementById('readout');
    const hEl = document.getElementById('h');
    const mEl = document.getElementById('m');
    const sEl = document.getElementById('s');
    const startBtn = document.getElementById('start');
    const pauseBtn = document.getElementById('pause');
    const resetBtn = document.getElementById('reset');
    const audioHint = document.getElementById('audioHint');

    let total = 0, left = 0, ticking = null;
    let audioCtx = null; // created on first Start

    function fmt(n){ return String(n).padStart(2,'0'); }
    function render(sec){
      const m = Math.floor(sec/60), s = sec%60;
      readout.textContent = `${fmt(m)}:${fmt(s)}`;
    }
    function inputsToSeconds(){
      const h = Math.max(0, parseInt(hEl.value||'0',10));
      const m = Math.max(0, parseInt(mEl.value||'0',10));
      const s = Math.max(0, parseInt(sEl.value||'0',10));
      return (h*3600)+(m*60)+s;
    }

    async function ensureAudio(){
      if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      if (audioCtx.state !== 'running') { await audioCtx.resume(); audioHint.style.display='none'; }
      return audioCtx;
    }
    function chime(){
      if (!audioCtx) return; // safety
      const now = audioCtx.currentTime;
      const g = audioCtx.createGain(); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, now);

      const notes = [880, 1175, 988]; // A6, D7, B6 ‚Äì soft friendly beeps
      notes.forEach((freq, i)=>{
        const t = now + i*0.18;
        const o = audioCtx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(freq, t);
        o.connect(g);
        g.gain.exponentialRampToValueAtTime(0.25, t+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.28);
        o.start(t); o.stop(t+0.3);
      });
    }

    function timeUp(){
      render(0); left = 0; clearInterval(ticking); ticking=null;
      // say via extension + play chime
      sendToPET({ type: "PET_SAY_NOW", text: "Time‚Äôs up!" }, ()=>{});
      if (audioCtx) chime();
    }

    startBtn.addEventListener('click', async ()=>{
      total = inputsToSeconds();
      if (total <= 0) return;
      await ensureAudio(); // user gesture unlocks sound
      left = total; render(left);
      clearInterval(ticking);
      ticking = setInterval(()=>{
        left -= 1; render(Math.max(0,left));
        if (left <= 0) timeUp();
      }, 1000);
    });

    pauseBtn.addEventListener('click', ()=>{
      if (ticking){ clearInterval(ticking); ticking=null; }
    });
    resetBtn.addEventListener('click', ()=>{
      clearInterval(ticking); ticking=null; left = inputsToSeconds(); render(left);
    });
    document.querySelectorAll('[data-preset]').forEach(b=>{
      b.addEventListener('click', (e)=>{
        const sec = parseInt(e.currentTarget.dataset.preset,10)||0;
        hEl.value = Math.floor(sec/3600);
        mEl.value = Math.floor((sec%3600)/60);
        sEl.value = sec%60;
        render(sec);
      });
    });

    // initial display
    left = inputsToSeconds(); render(left);
  </script>
</body>
</html>
